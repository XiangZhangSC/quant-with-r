---
title: "Pair trading strategy"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

library(tidyquant)
library(magrittr)
library(ggplot2)
```

```{r coke-pepsi}
# download daily prices for Coke and Pepsi stock from Yahoo Finance
coke <- tq_get("COKE", get = "stock.prices", 
               from = "2013-01-01", to = "2014-01-01")
pepsi <- tq_get("PEP", get = "stock.prices", 
                from = "2013-01-01", to = "2014-01-01")

# it is assumed that if Coke goes up on a particular day, 
# then so should Pepsi. 
# as a result, we focus on price changes of these two stocks

calculate_price_change <- function(stock_price_df) {
  price_change_df <- stock_price_df %>% 
    tq_mutate(select = adjusted, mutate_fun = diff.xts) %>% 
    dplyr::select(symbol, date, diff.xts) %>% 
    dplyr::filter(!is.na(diff.xts)) # the first entry naturally contains a missing value (NA) because there is no previous price
  
  return(price_change_df)
}


coke_price_change <- calculate_price_change(coke) 
pepsi_price_change <- calculate_price_change(pepsi)

# make a data frame with daily price change for Coke and Pepsi
price_change_df <- coke_price_change %>% 
  dplyr::bind_rows(pepsi_price_change) %>% 
  tidyr::pivot_wider(id_cols = date, names_from = symbol, values_from = diff.xts)

# make a scatter plot of Coke versus Pepsi price changes over a year
# as shown in figure 6.1
ggplot(price_change_df, aes(COKE, PEP)) + 
  geom_point(shape = 1, size = 3) + 
  theme_bw() + 
  labs(x = "Coke price changes", y = "Pepsi price changes", 
       title = "Pepsi versus Coke price changes")
```

## Why pair trading?

This is how we can create a **stationary** time series for an artificial stock, called **spread**. 
Importantly, this artificial stock is a great candidate for mean-reverting, and its price can be represented as 

$$\text{spread price(t)} = \frac{x(t) A(t) + y(t) B(t)}{x(t) + y(t)}$$
$A(t)$ and $B(t)$ represent the stock price for stock A and B at time $t$. 
$x(t)$ and $y(t)$ represent the shares that one has for stock A and B at time $t$

We can see that essentially the spread price is a weighted average of stock price A and B. 

$$
\begin{align}
w_A &= \frac{x(t)}{x(t) + y(t)} \\
w_B &= \frac{y(t)}{x(t) + y(t)} \\
\text{spread price(t)} &= w_A A(t) + w_B B(t)
\end{align}
$$

Since the time series $\text{spread price(t)}$ is stationary, in other words the spread price does not change over time, this indicates $\text{spread price(t + 1)} \approx \text{spread price(t)}$. 
Meanwhile $\text{spread price(t + 1)} = w_A A(t+1) + w_B B(t+1)$. 
This means

$$
\begin{align}
w_A A(t+1) + w_B B(t+1) &\approx w_A A(t) + w_B B(t) \\
w_A [A(t+1) - A(t)] &\approx -w_B [B(t+1) - B(t)] \\
w_A \times \text{price change A} &\approx -w_B \times \text{price change B} \\
\text{price change A} &\approx -\frac{w_B}{w_A} \times \text{price change B} \\
\text{price change A} &= -\frac{w_B}{w_A} \times \text{price change B} + \epsilon
\end{align}
$$

$\epsilon$ is the random error which is normally distributed.
The $-\frac{w_B}{w_A}$ is the regression coefficient $\beta$. 
$\frac{w_B}{w_A}$ is also called **hedge ratio**. 
We also realize that $\beta$ **cannot** be a positive number. 

## How does pair trading work?

1. estimate the spread beta $\beta$ based on the price change data. 
2. calculate the proportion of stock A based on the $\beta$.  
3. construct the spread based on the weighted average of stock price of A and B

$$
\begin{align}
\beta &= -\frac{w_B}{w_A} \\
-\frac{w_B}{w_A} &= 1 - \frac{1}{w_A} \\
\beta &= 1 - \frac{1}{w_A} \\
w_A &= \frac{1}{1 - \beta} \\
w_A &= \frac{x(t)}{x(t) + y(t)} \\
y(t) &= \frac{x(t)}{w_A} - x(t) \\
\Delta x &= x(t) - x(t-1) \\
\Delta y &= y(t) - y(t-1) \\ 
&= \frac{x(t)}{w_A} - x(t) - [\frac{x(t-1)}{w_A} - x(t-1)] \\
&= \frac{\Delta x}{w_A} - \Delta x
\end{align}
$$

$\Delta x$ ($\Delta y$) is the number of shares we need to tread (buy if it is positive, or sell if it is negative). 
Since $0 < w_A \leq 1$, $\Delta y$ must be $< 0$ if $\Delta x > 0$. 
This explains why in the pair trading strategy when one purchases stock A and he needs to sell stock B. 

```{r estimation-spread-beta, echo=TRUE}
calculate_spread_beta <- function(price_change_a, price_change_b, constrained = TRUE) {
  
  my_data <- data.frame(price_change_a = as.numeric(price_change_a), 
                        price_change_b = as.numeric(price_change_b))
  
  if (constrained == FALSE) {
    my_fit <- lm(price_change_a ~ 0 + price_change_b, data = my_data)
    spread_beta <- my_fit$coefficients["price_change_b"]
  } else {
    # The above lm() does not provide a way to restrict coefficients. 
    # Instead we can use the function nls under the algorithm port. 
    # This allow us to provide start for the coefficients, as well as upper and lower boundaries.
    my_fit <- stats::nls(price_change_a ~ spread_beta * price_change_b, data = my_data, start = list(spread_beta = -1), lower = c(spread_beta = -Inf), upper = c(spread_beta = 0), algorithm = "port")
    spread_beta <- stats::coef(my_fit)
  }
  return(spread_beta)
}
```

Without the constraint that spread beta cannot be a positive number, we get the spread beta `r calculate_spread_beta(price_change_a = price_change_df$COKE, price_change_b = price_change_df$PEP, constrained = FALSE)`. 
This means the proportion of Coke is `r 1/(1 - calculate_spread_beta(price_change_a = price_change_df$COKE, price_change_b = price_change_df$PEP, constrained = FALSE))`. 
This is not possible, because the proportion of a stock cannot be larger than 1. 

Once we have the value of spread beta, the next step is to construct a spread price series.

```{r construct-series, echo=TRUE}
# define the function to calculate the spread price per share
calculate_spread <- function(p1, p2, b) {
  # p1 = stock A price per share at time t
  # p2 = stock B price per share at time t
  # b = spread beta
  
  w1 <- 1 / (1 - b) # proportion of stock A 
  w2 <- 1 - w1 # proportion of stock B
  spread_price <- w1 * p1 + w2 * p2
  return(spread_price)
}
```

```{r convenient-functions}
# Since we need to update the price change data every time when we change 
# the stock or date, I make a function to automate the process
get_price_change_data <- function(stock1, stock2) {
  
  stock1_price_change <- calculate_price_change(stock1) 
  stock2_price_change <- calculate_price_change(stock2)
  
  # make a data frame with daily price change for the pair stocks
  price_change_df <- stock1_price_change %>%
    dplyr::bind_rows(stock2_price_change) %>% 
    tidyr::pivot_wider(id_cols = date, names_from = symbol, values_from = diff.xts)
  
  return(price_change_df)
}
```

## Example spread between Coke and Pepsi

```{r in-sample-spread}
# to match the figure 7.5 in the book "How to Build Your Own Algorithmic Trading Business"
# the start and end date needs to be changed
# in addition, in the same book the symbol for Coke is KO
coke <- tq_get("KO", get = "stock.prices", 
               from = "1977-01-01", to = "2008-12-31")
pepsi <- tq_get("PEP", get = "stock.prices", 
                from = "1977-01-01", to = "2008-12-31")

# get the price change data frame for the pair stocks
price_change_df <- get_price_change_data(coke, pepsi)

# based on the price change data, calculate the spread beta
spread_beta <- calculate_spread_beta(price_change_df$KO, price_change_df$PEP)

# construct a spread for Coke and Pepsi pair trading
# that is similar to the figure 7.5 in the book "How to Build Your Own Algorithmic Trading Business"
coke_pepsi_spread <- calculate_spread(p1 = coke$adjusted, p2 = pepsi$adjusted, b = spread_beta)

tibble::tibble(date = coke$date, spread = coke_pepsi_spread) %>% 
  ggplot(aes(date, spread)) + 
  geom_line() + 
  theme_bw() + 
  labs(x = NULL, y = "Spread price (in $)")
```

As we can see the spread price series is not stationary. 

## Example spread between AAPL and SPY

```{r aapl-spy-data}
spy <- tq_get("SPY", get = "stock.prices", 
               from = "2011-01-01", to = "2012-12-31")
aapl <- tq_get("AAPL", get = "stock.prices", 
                from = "2011-01-01", to = "2012-12-31")

# make a data frame with daily price change for AAPL and SPY
price_change_df <- get_price_change_data(spy, aapl)

# make a scatter plot of as shown in figure 6.4
ggplot(price_change_df, aes(SPY, AAPL)) + 
  geom_point(shape = 1, size = 3) + 
  theme_bw() + 
  labs(x = "SPY price changes", y = "AAPL price changes", 
       title = "AAPL versus Coke price changes") + 
  geom_smooth(method = "lm", se = FALSE)
```

In the texts, the in sample date ranged from 2009-01-01 to 2011-12-31. 
However, the figure 6.5 ranged from 2011-01-01 to 2011-12-31. 
Since the goal here is to reproduce the figure 6.5, I used the same dates as the figure suggested. 
The scatter plot showed that the AAPL and SPY positively correlated. 
I artificially flipped the AAPL price change, so that the price change of these two stocks are negatively correlated. 
I do this because the spread beta cannot be a positive number and it is easier to work with a negatively correlated pair of price changes. 

```{r aapl-spy-in-sample-spread}
spy <- tq_get("SPY", get = "stock.prices", 
               from = "2011-01-01", to = "2011-12-31")
aapl <- tq_get("AAPL", get = "stock.prices", 
                from = "2011-01-01", to = "2011-12-31")

# make a data frame with daily price change for AAPL and SPY
price_change_df <- get_price_change_data(spy, aapl)

# flip the price change of AAPL
price_change_df$AAPL <- price_change_df$AAPL * -1

spread_beta <- calculate_spread_beta(price_change_df$AAPL, price_change_df$SPY) 

aapl_spy_spread <- calculate_spread(p1 = aapl$adjusted, p2 = spy$adjusted, b = spread_beta)

# make a line plot similar to Figure 6.5
in_sample_spread <- tibble::tibble(date = aapl$date, spread = aapl_spy_spread)

ggplot(in_sample_spread, aes(date, spread)) + 
  geom_line() + 
  theme_bw() + 
  labs(x = NULL, y = "Spread price (in $)", 
       title = "In sample spread between AAPL and SPY")
```

```{r aapl-spy-out-sample-spread}
spy_out <- tq_get("SPY", get = "stock.prices", 
               from = "2012-01-01", to = "2012-10-22")
aapl_out <- tq_get("AAPL", get = "stock.prices", 
                from = "2012-01-01", to = "2012-10-22")

# we use the in sample spread beta to construct the out sample spread
aapl_spy_spread_out <- calculate_spread(p1 = aapl_out$adjusted, p2 = spy_out$adjusted, b = spread_beta)

# make a line plot similar to Figure 6.5
out_of_sample_spread <- tibble::tibble(date = aapl_out$date, spread = aapl_spy_spread_out)
```

If one thinks that the in sample spread is stationary, we can then use the spread beta learned from the in sample period to inspect if the spread price series remain stationary in the out of sample period. 

```{r viz-spread-in-and-out}
# stack the in sample and out of sample spread data frame
in_sample_spread %>% 
  dplyr::bind_rows(out_of_sample_spread) %>% 
  ggplot(aes(date, spread)) + 
  # first layer is the react
  ## left react corresponds to the in sample spread
  geom_rect(xmin = lubridate::ymd("2011-01-01"), xmax = lubridate::ymd("2011-12-31"), 
            ymin = -Inf, ymax = Inf, fill = "skyblue", alpha = 0.2) + 
  geom_text(aes(x = lubridate::ymd("2011-07-01"), y = 30), label = "in sample") + 
  ## right react corresponds to the out of sample spread
  geom_rect(xmin = lubridate::ymd("2012-01-01"), xmax = lubridate::ymd("2012-12-31"), 
            ymin = -Inf, ymax = Inf, fill = "pink", alpha = 0.2) + 
  geom_text(aes(x = lubridate::ymd("2012-07-01"), y = 30), label = "out of sample") + 
  # second layer is the line
  geom_line() + 
  theme_bw() + 
  labs(x = NULL, y = "Spread price (in $)", 
       title = "AAPL ~ beta*SPY")
```

Here we can clearly see that the entire out of sample spread is above the in sample spread, so you will never have a buy signal in the out of sample period only sell signal. 

### Rolling spread beta

It is important to have the constraint that spread beta cannot be a positive number when we run the rolling spread beta based on price changes. 
Otherwise, we will get negative spread price value and the proportion of a stock can be over 100% or a negative number. 
Here we use `rollapply` from the `zoo` package to realize the rolling. 

```{r in-sample-rolling-beta, echo=TRUE}
window_length <- 10 # day

# calculate rolling spread beta based on price changes
#my_roll_fit <- roll::roll_lm(x = price_change_df$SPY, y = price_change_df$AAPL, width = window_length, intercept = FALSE)
# rolling_spread_betas <- my_roll_fit$coefficients

rolling_spread_betas <- zoo::rollapply(data = price_change_df, 
                                       width = window_length, 
                                       align = "right", 
                                       FUN = function(x) calculate_spread_beta(price_change_a = x[,3], price_change_b = x[,2], constrained = TRUE), 
                                       by.column = FALSE, 
                                       fill = NA)
```

```{r viz-rolling-beta}
# organize the rolling spread betas into a data frame
# each day will have its corresponding spread beta
rolling_spread_beta_df <- aapl %>% 
  dplyr::bind_rows(spy) %>% 
  dplyr::semi_join(price_change_df, by = "date") %>% 
  dplyr::select(symbol, date, adjusted) %>%
  tidyr::pivot_wider(id_cols = date, names_from = symbol, values_from = adjusted) %>% 
  dplyr::mutate(spread_beta = rolling_spread_betas)

# visualize the rolling betas
ggplot(rolling_spread_beta_df, aes(date, spread_beta)) + 
  geom_line() + 
  theme_bw() + 
  labs(x = NULL, y = "Spread beta", 
       title = "In sample AAPL ~ b * SPY")
```

Indeed, depending on the day the spread beta changes. 
Make sure that no spread beta is positive. 

```{r in-sample-rolling-spread}
# calculate the spread price series
rolling_spread <- rolling_spread_beta_df %>% 
  dplyr::mutate(spread = purrr::pmap_dbl(list(AAPL, SPY, spread_beta), 
                                     ~calculate_spread(p1 = ..1, 
                                                       p2 = ..2, 
                                                       b = ..3)))
# visualize the spread price series
ggplot(rolling_spread, aes(date, spread)) + 
  geom_line() + 
  theme_bw() + 
  labs(x = NULL, y = "Spread price (in $)", 
       title = "In sample rolling spread between AAPL and SPY")
```

We can see that there is no spread price is negative value. 
