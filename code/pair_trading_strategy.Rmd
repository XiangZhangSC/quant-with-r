---
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyquant)
library(magrittr)
library(ggplot2)
```

```{r coke-pepsi}
# download daily prices for Coke and Pepsi stock from Yahoo Finance
coke <- tq_get("COKE", get = "stock.prices", 
               from = "2013-01-01", to = "2014-01-01")
pepsi <- tq_get("PEP", get = "stock.prices", 
                from = "2013-01-01", to = "2014-01-01")

# it is assumed that if Coke goes up on a particular day, 
# then so should Pepsi. 
# as a result, we focus on price changes of these two stocks

calculate_price_change <- function(stock_price_df) {
  price_change_df <- stock_price_df %>% 
    tq_mutate(select = adjusted, mutate_fun = diff.xts) %>% 
    dplyr::select(symbol, date, diff.xts) %>% 
    dplyr::filter(!is.na(diff.xts)) # the first entry naturally contains a missing value (NA) because there is no previous price
  
  return(price_change_df)
}


coke_price_change <- calculate_price_change(coke) 
pepsi_price_change <- calculate_price_change(pepsi)

# make a scatter plot of Coke versus Pepsi price changes over a year
# as shown in figure 6.1
coke_price_change %>% 
  dplyr::bind_rows(pepsi_price_change) %>% 
  tidyr::pivot_wider(id_cols = date, names_from = symbol, values_from = diff.xts) %>% 
  ggplot(aes(COKE, PEP)) + 
  geom_point(shape = 1, size = 3) + 
  theme_bw() + 
  labs(x = "Coke price changes", y = "Pepsi price changes", 
       title = "Pepsi versus Coke price changes")
```

## Why pair trading?

This is how we can create a **stationary** time series for a artificial stock, called **spread**. 
The price of this artificial stock can be represented as 

$$\text{spread price(t)} = \frac{x A(t) + y B(t)}{x + y}$$
$A(t)$ ad $B(t)$ represent the stock price for stock A and B at the time $t$. 

## Why one needs to purchase stock A and sell stock B in pair trading?

Since the time series $\text{spread price(t)}$ is stationary, in other words the spread price does not change over time, this indicates $\text{spread price(t + 1)} \approx \text{spread price(t)}$. 
Meanwhile $\text{spread price(t + 1)} = \frac{x A(t + 1) + y B(t + 1)}{x + y}$. 
This means $x A(t + 1) + y B(t + 1) \approx x A(t) + y B(t)$. 
If we rearrange the equation we have 
$$
\begin{align}
x A(t + 1) - x A(t) &\approx  y B(t) - y B(t + 1) \\
x[A(t + 1) - A(t)] &\approx -y[B(t + 1) - B(t)]
\end{align}
$$
There is a negative sign in front of $y$, meaning selling $y$ shares of stock B. 
In contrast, stock A needs to be purchased at $x$ shares. 
